<html>
    <head>
        <link href="bootstrap.min.css" rel="stylesheet">
        <link rel="stylesheet" type="text/css" href="dc.css"/>
        <script type="text/javascript" src="js/d3.js"></script>
        <script type="text/javascript" src="js/crossfilter.js"></script>
        <script type="text/javascript" src="js/dc.js"></script>
        <script type="text/javascript" src="reductio.min.js"></script>       
    </head>
    <body>MedData Dashboard</body>
    <div class="container">
        <div class="row">
            <div id="select1">
                <div>
                    <a class='reset' href="javascript:console.log(select1);select1.filterAll();dc.redrawAll('reductio')"  style='visibility: hidden;'>reset</a>
                </div>
            </div>
        </div>
        <div class="row">    
            <div id="ring-chart-exposure" class="col-sm-6"></div>
            <div id="row-chart-profession" class="col-sm-6"></div>
            <div id="bar-chart-profession" class="col-sm-6"></div>
            
        </div>
    </div>   
<script language="javascript">
var exposureGroup;
var exposureDim;
var professionDim;
var select1 = dc.selectMenu('#select1',"reductio");
//d3.csv("New.csv", function(error,data) {    
//d3.csv("MDG_Combined_Audience-Exposure_Dataset.csv", function(error,data) {
d3.csv("MDG_Combined_Audience-Exposure_Dataset.csv").then(function(data) {    
    //console.log(error);  
    //if (error) throw error;
    data.forEach(function(d) {
    d["Exposed"] = +d["Exposed"];
    d["Not exposed"] = +d["Not exposed"];
  });
    ndx=crossfilter(data);

    exposureDim     =   ndx.dimension(function(d){return d["Exposed"]==""?"exposed":"not-exposed"});
    professionDim   =   ndx.dimension(function(d){return d["MDG PROFESSION"]});

    //professionGroupNonDistinct=professionDim.group().reduceCount();

    professionGroup=professionDim.group();
    exposureGroup=exposureDim.group();

    /*var reducer =   reductio()
                    .exception(function(d) { return d.MDG_PSID; })
                    .exceptionCount(true);
                    //.exceptionSum(function(d) { return d.num; });
    */

    var reducer1 = reductio();
    reducer1.exception(function(d){return d.MDG_PSID;}).exceptionCount(true);
    reducer1.value("Exposed").exception(function(d) { return d.MDG_PSID; }).exceptionSum(function(d) { return d["Exposed"]; });
    reducer1.value("NotExposed").exception(function(d) { return d.MDG_PSID; }).exceptionSum(function(d) { return d["Not exposed"]; });

    //professionGroup1=professionDim.group();
    reducer1(professionGroup);

    //reducer(exposureGroup);
    //reducer(professionGroup);
    //console.log(exposureGroup);
    

    //var ExposureRing        = dc.pieChart("#ring-chart-exposure","reductio");
    //var ProfessionRowChart  = dc.rowChart("#row-chart-profession","reductio");
    
    select1
    .dimension(professionDim)
    .group(professionDim.group())
    .controlsUseVisibility(true);



function getTops(source_group,count) {
    return{
        all:function()
        {
            return source_group.top(count);
        }
    };
}
var ProfessionBarChart  = dc.barChart("#bar-chart-profession","reductio");
var TopProfession = getTops(professionGroup,1);


ProfessionBarChart
    .width(400)
    .height(380)
    .x(d3.scaleBand())
    .xUnits(dc.units.ordinal)
    .brushOn(false)
    .xAxisLabel('Profession')
    //.yAxisLabel('')
    .dimension(professionDim)
    .barPadding(0.1)
    .outerPadding(0.05)
    .group(TopProfession,"Exposed")
    .valueAccessor(function(p)
    {
        //console.log(p);
        //console.log(p.value.exceptionCount);
        console.log("ppppppppppppppppppppppppppp");
        console.log(p);
        console.log("ppppppppppppppppppppppppppp");
        return p.value.Exposed.exceptionSum;
    })
    .title(function(d) 
    {
        console.log(d);
        return d.key + '[' + this.layer + ']: ' + d.value[this.layer].exceptionSum;
    })
    .stack(TopProfession, "NotExposed", function (p) 
    {
        console.log("-------------------------------");
        console.log(p);
        return p.value.NotExposed.exceptionSum;
        console.log("-------------------------------");
    })
    .legend(dc.legend().x(100).y(0).itemHeight(13).gap(5));
/*
    ProfessionBarChart
    .width(768)
    .height(480)
    .x(d3.scale.linear().domain([6,20]))
    .brushOn(false)
    .yAxisLabel("This is the Y Axis!")
    .dimension(professionDim)
    .group(professionGroupNonDistinct)
    .valueAccessor(function(p){
        console.log("ppppppp")
        console.log(p);
        console.log(p.value.exceptionCount);

        console.log("ppppppp")
        return p.value.exceptionCount;
    })
    .on('renderlet', function(chart) {
        chart.selectAll('rect').on("click", function(d) {
            console.log("click!", d);
        });
        
    });
    */


    /*
    ExposureRing
    .width(250).height(250)
    .dimension(exposureDim)
    .group(exposureGroup)
    .legend(dc.legend())
    .valueAccessor(function (p) {
            return p.value.exceptionCount;
        })
    .innerRadius(60)
    .label(function(d){
        var totalCount=0;
        var label="";
        for(i=0;i<exposureGroup.all().length;i++)
        {
            totalCount=totalCount+exposureGroup.all()[i].value.exceptionCount;
        }
        label += d.key + '-' + Math.floor(d.value.exceptionCount / totalCount * 100) + '%';
        return label;
        });
    */
    /* 
     ProfessionRowChart
    .dimension(professionDim)
    .group(professionGroup)
    .elasticX(true)
    .valueAccessor(function (p) {
            return p.value.exceptionCount;
        })
        .labelOffsetX(10)
    .on('renderlet', function(chart) {
        chart.selectAll('rect').on("click", function(d) {
            console.log("click!", d);
        });
    });
    */

    dc.renderAll("reductio");
});

    </script>
    </html>